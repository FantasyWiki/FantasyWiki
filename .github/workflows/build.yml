name: CI/CD Process
on:
  workflow_call:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: DanySK/action-checkout@0.2.28
      - name: Determine dry-run flag
        id: check_branch
        shell: bash
        run: |
          ruby << 'RUBY' >> $GITHUB_OUTPUT
            branch = ENV['GITHUB_REF'].sub(/^refs\/heads\//, '')
            keywords = %w[gradle kotlin publish release deploy]
            dry = keywords.any? { |kw| branch.include?(kw) } ? '' : '--dry-run'
            puts "dry_run=#{dry}"
          RUBY
      - name: Check
        run: ./gradlew check
  success:
    runs-on: ubuntu-24.04
    needs:
      - build
    if: >-
      always() && (
        contains(join(needs.*.result, ','), 'failure')
        || !contains(join(needs.*.result, ','), 'cancelled')
      )
    steps:
      - name: Verify that there were no failures
        run: ${{ !contains(join(needs.*.result, ','), 'failure') }}
